CREATE DATABASE VIDEOCLUB


CREATE TABLE DIRECTOR(
	NOMBRE VARCHAR(40),
	NACIONALIDAD VARCHAR(40),
	CONSTRAINT PK_DIRECTOR PRIMARY KEY (NOMBRE),
);
CREATE TABLE PELICULA(
	ID INT, 
	TITULO VARCHAR(40) NOT NULL,
	PRODUCTORA VARCHAR(40),
	NACIONALIDAD VARCHAR(40),
	FECHA DATE,
	DIRECTOR VARCHAR(40),
	CONSTRAINT PK_PELICULA PRIMARY KEY (ID),
	CONSTRAINT FK_DIRECTOR FOREIGN KEY (DIRECTOR) REFERENCES DIRECTOR(NOMBRE)
);

CREATE TABLE EJEMPLAR(
	IDPELICULA INT,
	NUMERO INT,
	ESTADO VARCHAR(40),
	CONSTRAINT PK_EJEMPLAR PRIMARY KEY(IDPELICULA, NUMERO),
	CONSTRAINT FK_EJEMPLAR FOREIGN KEY(IDPELICULA) REFERENCES PELICULA(ID)
);

CREATE TABLE ACTORES(
	NOMBRE VARCHAR(40),
	NACIONALIDAD VARCHAR(40),
	SEXO CHAR(1),
	CONSTRAINT PK_ACTORES PRIMARY KEY(NOMBRE),
	CONSTRAINT CK_SEXO CHECK (SEXO IN ('H', 'M'))
);

CREATE TABLE SOCIO(
	DNI VARCHAR(9),
	NOMBRE VARCHAR(40)  NOT NULL,
	DIRECCION VARCHAR(40),
	TELEFONO CHAR(9),
	AVALADOR VARCHAR(9),
	CONSTRAINT PK_SOCIO PRIMARY KEY(DNI),
	CONSTRAINT FK_SOCIO FOREIGN KEY(AVALADOR) REFERENCES SOCIO(DNI)
);

CREATE TABLE ACTUA(
	ACTOR VARCHAR(40),
	IDPELICULA INT, 
	PROTAGONISTA CHAR(1) DEFAULT 'N',
	CONSTRAINT PK_ACTUA PRIMARY KEY(ACTOR, IDPELICULA),
	CONSTRAINT CK_PROTAGONISTA CHECK (PROTAGONISTA IN ('S', 'N')),
	CONSTRAINT FK1_ACTUA  FOREIGN KEY (ACTOR) REFERENCES ACTORES(NOMBRE) ON DELETE CASCADE,
	CONSTRAINT FK2_ACTUA  FOREIGN KEY (IDPELICULA) REFERENCES PELICULA (ID) ON DELETE CASCADE,
);
CREATE TABLE ALQUILA(
	DNI VARCHAR(9),
	IDPELICULA INT,
	NUMERO INT,
	FECHA_ALQUILER DATE,
	FECHA_DEVOLUCION DATE,
	CONSTRAINT PK_ALQUILA PRIMARY KEY(DNI, IDPELICULA, NUMERO, FECHA_ALQUILER),
	CONSTRAINT FK1_DNI FOREIGN KEY(DNI) REFERENCES SOCIO(DNI),
	CONSTRAINT FK2_PELI FOREIGN KEY(IDPELICULA, NUMERO) REFERENCES EJEMPLAR(IDPELICULA, NUMERO),
	CONSTRAINT CK_FECHAS CHECK (FECHA_DEVOLUCION > FECHA_ALQUILER)
);

---------------------INSERCIONES-----------------------

-- DIRECTORES
INSERT INTO DIRECTOR VALUES ('JUAN', 'ESPAÑOLA');
INSERT INTO DIRECTOR VALUES ('PEDRO', 'ESPAÑOLA');

--PELICULAS
INSERT INTO PELICULA VALUES (001, 'LA GRANJA', 'TELE5', 'RUSA', '10/03/1987', 'JUAN');
INSERT INTO PELICULA VALUES (002, 'MANDINGO', 'ANTENA3', 'JAPONESA', '11/03/1988', 'JUAN');
INSERT INTO PELICULA VALUES (003, 'FRANCO', 'INTERECONOMIA','ESPAÑOLA', '01/01/1990','PEDRO');
INSERT INTO PELICULA VALUES (004, 'COSMOS','TELE5', 'ITALIANA', '15/10/2000', 'PEDRO');

--EJEMPLARES
INSERT INTO EJEMPLAR VALUES (001, 01, 'BIEN');
INSERT INTO EJEMPLAR VALUES (001, 02, 'MAL');
INSERT INTO EJEMPLAR VALUES (002, 01, 'BIEN');
INSERT INTO EJEMPLAR VALUES (002, 02, 'MAL');
INSERT INTO EJEMPLAR VALUES (003, 01, 'BIEN');
INSERT INTO EJEMPLAR VALUES (003, 02, 'REGULAR');
INSERT INTO EJEMPLAR VALUES (004, 01, 'BIEN');
INSERT INTO EJEMPLAR VALUES (004, 02, 'REGULAR');

--SOCIOS
INSERT INTO SOCIO VALUES (15405978, 'DANIEL', 'C/ NUEVA, 1', 697565656, NULL);
INSERT INTO SOCIO VALUES (15405979, 'ANA', 'C/ ANCHA, 5', 697545454, 15405978);
INSERT INTO SOCIO VALUES (15405971, 'SILVIA', 'C/ FORT, 4', 697121212, 15405979);
INSERT INTO SOCIO VALUES (15405972, 'XAVI', 'C/ ANCHA, 2', 197232323, 15405971);

--ACTORES
INSERT INTO ACTORES VALUES ('PENELOPE', 'ESPAÑOLA', 'M');
INSERT INTO ACTORES VALUES ('FRANCESCO', 'ITALIANA', 'H');
INSERT INTO ACTORES VALUES ('ANA', 'POLACA', 'M');
INSERT INTO ACTORES VALUES ('CARMEN', 'ESPAÑOLA', 'M');
INSERT INTO ACTORES VALUES ('ANDREA', 'ITALIANA', 'H');
INSERT INTO ACTORES VALUES ('VLADIMIR', 'RUSA', 'H');

--ACTUA
select * from ACTUA
INSERT INTO ACTUA VALUES ('ANDREA', 001, 'S');
INSERT INTO ACTUA VALUES ('VLADIMIR', 001, 'N');
INSERT INTO ACTUA VALUES ('CARMEN', 002, 'S');
INSERT INTO ACTUA VALUES ('PENELOPE', 003, 'S');
INSERT INTO ACTUA VALUES ('FRANCESCO',003, 'N');
INSERT INTO ACTUA VALUES ('ANA', 004, 'S');

--ALQUILA
select * from ALQUILA
INSERT INTO ALQUILA VALUES (15405978, 001,01, '01/01/2017', '03/01/2017');
INSERT INTO ALQUILA VALUES (15405979, 001,02, '01/01/2017', '03/01/2017');
INSERT INTO ALQUILA VALUES (15405971, 002,01, '01/02/2017', '03/02/2017');
INSERT INTO ALQUILA VALUES (15405978, 002,02, '01/02/2017', '03/02/2017');
INSERT INTO ALQUILA VALUES (15405972, 003,01, '01/03/2017', '03/03/2017');
INSERT INTO ALQUILA VALUES (15405972, 003,02, '01/03/2017', '03/03/2017');
INSERT INTO ALQUILA VALUES (15405979, 004,01, '01/04/2017', '03/04/2017');
INSERT INTO ALQUILA VALUES (15405979, 004,02, '01/04/2017', '03/04/2017');

--3. Cambia la nacionalidad para los directores a ESTADOUNIDENSE
UPDATE DIRECTOR
SET NACIONALIDAD = 'ESTADOUNIDENSE'
WHERE NACIONALIDAD = 'ESPAÑOLA'

select* from DIRECTOR
--4. Modifica los datos de todos los socios para que el avalista sea un único socio, siempre el
--mismo para todos, excepto para el propio avalista que no dispone de ninguno
UPDATE SOCIO 
SET AVALADOR = '15405978'
WHERE DNI != 15405978;
--5. Elimina los socios cuyo número de teléfono empiece por una cifra superior o igual a 5.
--¿Qué sucede? ¿Por qué?
DELETE SOCIO WHERE TELEFONO  >= '5%' 

-- Al borrar los registros, si dichos registros participan
-- en una relación, por ejemplo en la relación alquiler, no nos
-- va a dejar eliminarlos.
--6. Elimina todos los directores. ¿Qué sucede? ¿Por qué?
DELETE DIRECTOR;
-- No permite la eliminación de registros, puesto que dichos directores
-- tienen películas asociadas.
-- Podríamos modificar la FK_DIRECTOR de la tabla PELICULA para añadir
-- la cláusula ON DELETE CASCADE

--7. Elimina 2 películas, las que desees. ¿Qué sucede? ¿Por qué? ¿Cómo los solucionarías?
--¿Podría haberse evitado el problema con otro diseño físico? ¿Cómo?
DELETE PELICULA WHERE ID = 001 OR ID = 002;
-- No permite la eliminación de registros, puesto que dichas películas
-- tienen ejemplares asociados y además,aparezcen en la
-- relación ACTUA. Seria aconsejable usar ON DELETE CASCADE.